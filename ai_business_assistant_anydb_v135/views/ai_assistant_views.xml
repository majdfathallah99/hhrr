
<odoo>
  <!-- App tile opens the chat page -->
  <record id="action_ai_assistant_page" model="ir.actions.act_url">
    <field name="name">AI Assistant</field>
    <field name="type">ir.actions.act_url</field>
    <field name="url">/ai_assistant</field>
    <field name="target">self</field>
  </record>

  <menuitem id="menu_ai_app_root_clean" name="AI Assistant" action="action_ai_assistant_page" sequence="20"/>

  <!-- QWeb template: Chat page -->
  <template id="ai_chat_page" name="AI Assistant - Chat">
    <t t-call="website.layout">
      <t t-set="title">AI Assistant</t>
      <div class="container my-4">
        <h2>AI Assistant</h2>
        <div id="chatBox" class="border rounded p-3 mb-3" style="height: 300px; overflow:auto;">
          <div><strong>Assistant:</strong> Hi! Ask me about your Odoo data or tell me to create/update records.</div>
        </div>
        <div class="input-group">
          <input id="msgInput" type="text" class="form-control" placeholder="Type a message..." />
          <button id="sendBtn" class="btn btn-primary" type="button">Send</button>
          <a class="btn btn-secondary" href="/ai_assistant/voice" title="Voice mode">ðŸŽ™ Voice</a>
        </div>
      </div>
      <script>
        function appendChat(who, text) {
          const box = document.getElementById('chatBox');
          const div = document.createElement('div');
          div.innerHTML = '<strong>' + who + ':</strong> ' + text;
          box.appendChild(div);
          box.scrollTop = box.scrollHeight;
        }
        async function sendMessage() {
          const inp = document.getElementById('msgInput');
          const msg = inp.value.trim();
          if(!msg) return;
          appendChat('You', msg);
          inp.value='';
          try {
            const resp = await fetch('/ai_assistant/query_http', {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({"jsonrpc":"2.0","method":"call","params":{"message": msg}})
            });
            const j = await resp.json();
            const result = (j && j.result) ? j.result : j;
            appendChat('Assistant', result.text || '(no response)');
          } catch(e) {
            appendChat('Assistant', 'Network/server error.');
          }
        }
        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        document.getElementById('msgInput').addEventListener('keydown', function(e){ if(e.key==='Enter') sendMessage(); });
      </script>
    </t>
  </template>
</odoo>
